C51 COMPILER V9.01   ONE_DS18B20                                                           03/07/2020 14:49:38 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE ONE_DS18B20
OBJECT MODULE PLACED IN .\output\one_ds18b20.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil C51\C51\BIN\C51.EXE source\one_ds18b20.c OMF2 DEBUG PRINT(.\Listings\on
                    -e_ds18b20.lst) TABS(2) PREPRINT(.\Listings\one_ds18b20.i) OBJECT(.\output\one_ds18b20.obj)

line level    source

   1          /******************************************************************************
   2          文 件 名   : one_ds18b20.c
   3          
   4          @file one_ds18b20.c
   5          @brief ds18b20 温度传感器驱动
   6          
   7          ******************************************************************************/
   8          
   9          /*----------------------------------------------*
  10           * 包含头文件                                   *
  11           *----------------------------------------------*/
  12          #include "main.h"
  13          
  14          #ifdef ONE_DS18B20_DEV_DRIVER
  15          
  16          /*----------------------------------------------*
  17           * 宏定义                                 *
  18           *----------------------------------------------*/
  19          sbit DS18B20_DQ = P3^7;
  20          /*----------------------------------------------*
  21           * 枚举定义                            *
  22           *----------------------------------------------*/
  23          
  24          /*----------------------------------------------*
  25           * 结构体定义                              *
  26           *----------------------------------------------*/
  27          
  28          /*----------------------------------------------*
  29           * 外部函数原型说明                                     *
  30           *----------------------------------------------*/
  31          
  32          /*----------------------------------------------*
  33           * 内部函数原型说明                                   *
  34           *----------------------------------------------*/
  35          
  36          /*----------------------------------------------*
  37           * 全局变量                                     *
  38           *----------------------------------------------*/
  39          
  40          /*----------------------------------------------*
  41           * 常量定义                                       *
  42           *----------------------------------------------*/
  43          
  44          /*---------------------------------------------------------------------------*/
  45          /**
  46          *@brief ds18b20  延时
  47          *
  48          *
  49          *@param i: 延时
  50          *
  51          *@return 
  52          * 
  53          *
  54          *@note 
C51 COMPILER V9.01   ONE_DS18B20                                                           03/07/2020 14:49:38 PAGE 2   

  55          *
  56          */
  57          static void ds18b20_delay(uint16_t i)
  58          {
  59   1        while( i-- );
  60   1      }
  61          /*---------------------------------------------------------------------------*/
  62          /**
  63          *@brief ds18b20 复位
  64          *
  65          *
  66          *@param none
  67          *
  68          *@return true:成功, false:失败
  69          * 
  70          *
  71          *@note 
  72          *
  73          */
  74          static bool ds18b20_reset(void)
  75          {
  76   1        uint8_t x = 0;
  77   1        
  78   1        DS18B20_DQ = 1;///<DQ复位
  79   1        ds18b20_delay(8);///<稍做延时
  80   1        DS18B20_DQ = 0;///<单片机将DQ拉低
  81   1        ds18b20_delay(80);///<精确延时 大于 480us
  82   1        DS18B20_DQ = 1;///<拉高总线
  83   1        ds18b20_delay(14);
  84   1        x = DS18B20_DQ;///<稍做延时后 如果x=0则初始化成功 x=1则初始化失败
  85   1        ds18b20_delay(20);
  86   1      
  87   1        if(x == 0){
  88   2          return true;
  89   2        }else{
  90   2          return false;
  91   2        }
  92   1      }
  93          /*---------------------------------------------------------------------------*/
  94          /**
  95          *@brief ds18b20 读一个字节
  96          *
  97          *
  98          *@param none
  99          *
 100          *@return 读到的数据
 101          * 
 102          *
 103          *@note 
 104          *
 105          */
 106          static uint8_t ds18b20_read_one_char(void)
 107          {
 108   1        uint8_t i = 0;
 109   1        uint8_t dat = 0;
 110   1        
 111   1        for(i = 8; i > 0; i--){
 112   2          DS18B20_DQ = 0;       /* 给脉冲信号 */ 
 113   2          dat>>=1;
 114   2          DS18B20_DQ = 1;       /* 给脉冲信号 */ 
 115   2          if(DS18B20_DQ)
 116   2          dat|=0x80;
C51 COMPILER V9.01   ONE_DS18B20                                                           03/07/2020 14:49:38 PAGE 3   

 117   2          ds18b20_delay(4);
 118   2        }
 119   1        
 120   1        return dat;
 121   1      }
 122          
 123          /*---------------------------------------------------------------------------*/
 124          /**
 125          *@brief ds18b20 写一个字节
 126          *
 127          *
 128          *@param dat: 写字节数据
 129          *
 130          *@return 
 131          * 
 132          *
 133          *@note 
 134          *
 135          */
 136          static uint8_t ds18b20_write_one_char(uint8_t dat)
 137          {
 138   1        uint8_t i=0;
 139   1        
 140   1        for (i=8; i>0; i--){
 141   2          DS18B20_DQ = 0;
 142   2          DS18B20_DQ = dat&0x01;
 143   2          ds18b20_delay(5);
 144   2          DS18B20_DQ = 1;
 145   2          dat>>=1;
 146   2        }
 147   1        return dat;
 148   1      }
 149          /*---------------------------------------------------------------------------*/
 150          /**
 151          *@brief 读取温度, 返回的温度值 *10, 即一位小数
 152          *
 153          *
 154          *@param none
 155          *
 156          *@return 返回的温度值 *10, 即一位小数
 157          * 
 158          *
 159          *@note 
 160          *
 161          */
 162          int16_t ds18b20_read_temperature(void)
 163          {
 164   1        uint8_t a = 0;
 165   1        uint8_t b = 0;
 166   1        int16_t  t = 0;
 167   1        bool is_negative_temp = 0;
 168   1        
 169   1        __disable_irq();
 170   1        
 171   1        ds18b20_reset();
 172   1      
 173   1        ds18b20_write_one_char(0xCC);///<跳过读序号列号的操作
 174   1        ds18b20_write_one_char(0x44);///<启动温度转换
 175   1        ds18b20_delay(100);
 176   1        ds18b20_reset();
 177   1        
 178   1        ds18b20_write_one_char(0xCC);///<跳过读序号列号的操作
C51 COMPILER V9.01   ONE_DS18B20                                                           03/07/2020 14:49:38 PAGE 4   

 179   1        ds18b20_write_one_char(0xBE);///<读取温度寄存器等（共可读9个寄存器） 前两个就是温度
 180   1        a = ds18b20_read_one_char();
 181   1        b = ds18b20_read_one_char();
 182   1        
 183   1        __enable_irq(); 
 184   1      
 185   1        if( b > 0x7f ){ ///<最高位为1 时温度是负
 186   2          a = ~a + 1; 
 187   2          b = ~b;
 188   2          is_negative_temp = 1;
 189   2        }
 190   1      
 191   1        t = a >> 4;
 192   1        t += b << 4;
 193   1      
 194   1        a = (a&0x0f)*10 >> 4;
 195   1      
 196   1        t *= 10;
 197   1        t += a;
 198   1        
 199   1        if(is_negative_temp){
 200   2          t = -t;
 201   2        }
 202   1        
 203   1        return t;
 204   1      }
 205          /*---------------------------------------------------------------------------*/
 206          /**
 207          *@brief 温度传感器ds18b20初始化
 208          *
 209          *
 210          *@param none
 211          *
 212          *@return 
 213          * 
 214          *
 215          *@note 
 216          *
 217          */
 218          void ds18b20_init(void)
 219          {
 220   1        ds18b20_reset();
 221   1      
 222   1        ds18b20_write_one_char(0xcc);///<忽略ROM指令
 223   1        ds18b20_write_one_char(0x4e);///<写暂存器指令
 224   1        ds18b20_write_one_char(0);///<TH值未使用
 225   1        ds18b20_write_one_char(0);///<TL值未使用
 226   1        ds18b20_write_one_char(0x1f);///<采用bit数。
 227   1      
 228   1        ds18b20_read_temperature();///<第一次读取值错误,丢弃
 229   1      }
 230          /*---------------------------------------------------------------------------*/
 231          #endif//ONE_DS18B20_DEV_DRIVER
 232          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    296    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
C51 COMPILER V9.01   ONE_DS18B20                                                           03/07/2020 14:49:38 PAGE 5   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
